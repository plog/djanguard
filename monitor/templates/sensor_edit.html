{% extends "monitor_base.html" %}
{% load static %}
{% load form_tags %}
{% block content %}


<h1 class="pl-3">Edit Sensor</h1>
<!-- Section 1: Form to update main Sensor properties -->
<div class="row mb-4 mx-3 box p-3">
    <div class="col-7 align-top">
        <form id="sensor-edit-form">
            <div class="row">
                <div class="col">
                    <div class="mb-2">
                        <label for="name" class="form-label">Name:</label>
                        <input type="text" onkeypress="return onlyAlphaNumericKey(event)" id="name" name="name" class="form-control  form-control-sm" value="{{ sensor.name }}" required>
                    </div>                    
                </div>
                <div class="col-5">
                    <div class="mb-2">
                        <label for="frequency" class="form-label">Frequency:</label>
                        <input type="number" onkeypress="return onlyNumberKey(event)" id="frequency" name="frequency" class="form-control  form-control-sm" value="{{ sensor.frequency }}" required>
                    </div>                    
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="mb-2">
                        <label for="url" class="form-label">Base URL:</label>
                        <input type="url" id="url" name="url" class="form-control  form-control-sm" value="{{ sensor.url }}" required>
                    </div>
                </div>
                <div class="col-5">
                    <div class="row">
                        <div class="col-4">
                            <button type="button" id="update-sensor" class="btn btn-primary btn-sm mt-4">Save</button>
                        </div>
                        <div class="col-1" style="padding-top: 1.30rem !important;">
                            <i class="bi bi-check-circle" style="color:green; display: none;font-size: x-large;" id="updated-sensor" ></i>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <div class="col-5 align-top context-doc doc1">
        The name must only contain numbers and letters. The URL should be valid, ideally using the top-level domain (you can add specific paths in the actions). Frequency is in seconds and must be at least 10 for free accounts.
    </div>    
</div>    

<!-- Section 2: List of all actions linked to this Sensor -->
<h1>Actions</h1>
<div class="row mb-4 mx-3 box p-3">
    <table id="action-table" class="table table-bordered">
        <tbody>
            <!-- Data will be populated here by AJAX -->
        </tbody>
    </table>
    <div class="row">
        <div class="col-3">
            <button type="button" id="add-new-action" class="btn btn-success btn-sm mt-3">Add New Action</button>
        </div>
    </div>
</div>

<!-- Section 3: Form to add or edit an Action -->
<h1 id="addEditActionTitle">New Action</h1>
<div class="row mb-4 mx-3 box p-3">
    <div class="col-7 align-top">
        <div id="action-form-container">
            <form id="action-form">
                <input type="hidden" id="action-id" name="action_id">
                <div class="mb-2">
                    <label for="action_name" class="form-label">Action Name:</label><span class="require">*</span>
                    <input type="text" id="action_name" name="action_name" class="form-control form-control-sm" required>
                </div>
                <div class="mb-2">
                    <label for="action_path" class="form-label">Action Path:</label><span class="require">*</span>
                    <input type="text" id="action_path" name="action_path" class="form-control form-control-sm" required>
                </div>

                <div class="mb-2">
                    <label for="action_type" class="form-label">Action Type:</label><span class="require">*</span>
                    <select id="action_type" name="action_type" class="form-select form-select-sm" required>
                        <option value="GET"    >GET</option>
                        <option value="POST"   >POST</option>
                        <option value="PUT"    >PUT</option>
                        <option value="DELETE" >DELETE</option>
                        <option value="PATCH"  >PATCH</option>
                        <option value="HEAD"   >HEAD</option>
                        <option value="OPTIONS">OPTIONS</option>
                        <option value="TRACE"  >TRACE</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="assertion_type" class="form-label">Assertion Type:</label><span class="require">*</span>
                    <select id="assertion_type" name="assertion_type" class="form-select form-select-sm" required>
                        <option value="status_code"     >Status Code</option>
                        <option value="contains_keyword">Contains Keyword</option>
                        <option value="selenium"        >Selenium Style</option>
                        <option value="json_key_exists" >JSON Key Exists</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="expected_value" class="form-label">Expected Value:</label><span class="require">*</span>
                    <input type="text" id="expected_value" name="expected_value" class="form-control form-control-sm" required>
                </div>
                <div id="selenium-section" class="mb-2" style="display: none;">
                    <label for="selenium_script" class="form-label">Selenium style:</label>
                    <textarea id="selenium_script" name="selenium_script" class="form-control form-control-sm" rows="5"></textarea>
                </div>                
                <div id="payload-section" class="mb-2">
                    <label for="payload" class="form-label">Payload:</label>
                    <textarea id="payload" name="payload" class="form-control form-control-sm" rows="5"></textarea>
                </div>

                <div class="row">
                    <div class="col-2 pt-1">
                        <button type="button" id="save-action" class="btn btn-sm btn-primary">Save</button>
                    </div>
                    <div class="col-2 pt-1">
                        <button type="button" id="test-action" class="btn btn-sm btn-primary" style="display: none;">Test</button>
                    </div>                    
                    <div class="col-1 pt-0">
                        <i class="bi bi-check-circle" style="color:green; display: none;font-size: x-large;" id="updated-action" ></i>
                    </div>
                </div>
                
            </form>
        </div>
    </div>

    <div class="col-5 align-top context-doc doc2" id="test-result">

    </div>
</div>

<script>
const user     = parseInt({{request.user.id}});
const sensorId = parseInt('{{ sensor.id }}');

function help(){
    const helpMessages = {
        action_name: "Enter a name for the action. This will help identify what this action is for.",
        action_path: "Enter the path for the action. This should be the endpoint you want to target. Start with '/' if sensor's URL does not end with '/'",
        action_type: "Select the HTTP method for the action. This determines how the action interacts with the API (e.g., GET, POST, DELETE).",
        assertion_type: "Select the type of assertion you want to make. This will verify if the response meets your expectations.",
        expected_value: "Enter the expected value for the assertion. This can be a status code, a keyword, or a specific JSON key depending on the assertion type.",
        selenium_script: "Enter the Selenium script if you are using Selenium for testing. This will be executed to verify the behavior.",
        payload: "Enter the payload to be sent with the request. This is generally used for POST, PUT, and PATCH actions."
    };
    const assertionHelpMessages = {
    "status_code": 'Check if the response status code matches the expected value, e.g., 200 for success. \n\nIf you use Payload, it must be \n{\n"headers": {....},\n"data": {....}\n}',
    "contains_keyword": 'Verify if the response contains a specific keyword. Useful for checking text presence. \n\nIf you use Payload, it must be \n{\n"headers": {....},\n"data": {....}\n}',
    "selenium": "Use Selenium to simulate browser actions for deeper testing. Commands can include:\n" +
        "- check-element-exists \"selector\": Verify if an element exists.\n" +
        "- fill \"selector\" with \"value\": Fill an input field with a given value.\n" +
        "- click \"selector\": Click on an element.\n" +
        "- check-text \"text\" is-present: Check if specific text is present.\n" +
        "- assert title \"expected_title\": Assert that the browser's title matches the expected value.\n" +
        "- assert element present \"selector\": Assert that an element is present.\n" +
        "- assert element not present \"selector\": Assert that an element is not present.\n" +
        "- pause: Pause the execution.\n" +
        "- click at \"x\" \"y\": Click at specific coordinates.\n" +
        "- double click \"selector\": Double-click on an element.\n" +
        "- drag and drop \"source\" to \"target\": Drag an element from source to target.\n" +
        "- mouse over \"selector\": Move the mouse over an element.\n" +
        "- set window size \"width\" \"height\": Set the browser window size.\n\n" +
        "Note: This is a work in progress, and we are still testing all of these commands.",
    "json_key_exists": "Check if a specific key exists in the JSON response. Useful for validating API structures."
};
    const formFields          = document.querySelectorAll('#action-form input, #action-form select, #action-form textarea');
    const assertionTypeSelect = document.getElementById('assertion_type');

    // Iterate over each field and add event listeners
    formFields.forEach(field => {
        field.addEventListener('focus', function() {
            // Update the help message in the #test-result div
            const message = helpMessages[this.id] || "No help available for this field.";
            document.getElementById('test-result').innerText = message;
        });

        // Optional: Clear the help message when the field loses focus
        field.addEventListener('blur', function() {
            document.getElementById('test-result').innerText = "Fill in the details to add or modify an action. Make sure all fields are correctly filled out to ensure proper functionality.";  // Default or placeholder help message
        });
        assertionTypeSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            const helpMessage = assertionHelpMessages[selectedValue] || "Select an assertion type to get more information.";
            document.getElementById('test-result').innerText = helpMessage;
        });        
    });     
}

function saveAction(callback) {
        const actionId = $('#action-id').val();
        let method     = null;
        let url        = null;

        if(actionId){
            url    = `/api/action/${actionId}/`;
            method = 'PUT';
        }else{
            url    = `/api/action/`;
            method = 'POST';
        }
        // Client-side validation
        const actionName      = $('#action_name').val();
        const actionType      = $('#action_type').val();
        const actionPath      = $('#action_path').val();
        const assertionType   = $('#assertion_type').val();
        const payload         = $('#payload').val();
        const selenium_script = $('#selenium_script').val().replace(/\\"/g, '"');
        let expectedValue     = $('#expected_value').val();

        if (!actionName || !actionType || !actionPath || !assertionType || !expectedValue) {
            alert('Please fill in all required fields before saving.');
            return;
        }

        const actionData = {
            action_name     : actionName,
            action_type     : actionType,
            action_path     : actionPath,
            assertion_type  : assertionType,
            expected_value  : expectedValue,
            payload         : payload,
            selenium_script : selenium_script,
            sensor          : sensorId,
        };

        $.ajax({
            url: url,
            method      : method,
            contentType : 'application/json',
            headers     : {'X-CSRFToken': Cookies.get('csrftoken')},
            data        : JSON.stringify(actionData),
            success: function(response) {
                console.log('Action saved successfully!');
                loadActions();
                if (callback) callback(response.id);
                $('#updated-action').show().delay(2000).fadeOut();;
                $('#test-action').show();
            },
            error: function(error) {
                console.error('Error saving action:', error);
                if (error.status === 400) {
                    alert('Validation failed.' + error.responseText);
                } else {
                    alert('An unexpected error occurred while saving the action.');
                }
            }
        });  
    }

// Load Actions LIST 
function loadActions() {
    $.ajax({
        url: `/api/action/?sensor=${sensorId}`,
        method: 'GET',
        success: function(data) {
            let tableContent = '';
            data.forEach(function(action) {
                tableContent += `<tr>
                    <td>${action.action_name}</td>
                    <td>${action.action_type}</td>
                    <td>${action.action_path}</td>
                    <td nowrap width="1">
                        <a class="edit-action text-black mx-1" data-id="${action.id}"><i class="bi bi-pencil-square"></i></a>
                        <a class="delete-action text-danger mx-1" data-id="${action.id}"><i class="bi bi-trash3-fill"></i></a>
                    </td>
                </tr>`;
            });
            $('#action-table tbody').html(tableContent);
        },
        error: function(error) {
            console.error('Error fetching actions:', error);
        }
    });
}

function clearActionForm(){
        $('#addEditActionTitle').html('New Action')
        $('#action-id').val(null);
        $('#action-form')[0].reset();
        $('#selenium-section').hide();
        $('#action-form-title').text('New Action');    
        $('#test-action').hide();    
        help();
    }

$(document).ready(function() {
    // Update Sensor properties
    $('#update-sensor').click(function() {
        const data = {
            name: $('#sensor-edit-form #name').val(),
            url: $('#sensor-edit-form #url').val(),
            frequency: $('#sensor-edit-form #frequency').val(),
            user:user
        };
        $.ajax({
            url: `/api/sensor/${sensorId}/`,
            method: 'PUT',
            contentType: 'application/json',
            headers: {'X-CSRFToken': Cookies.get('csrftoken')},
            data: JSON.stringify(data),
            success: function(response) {
                console.log('Sensor updated successfully!');
                $('#updated-sensor').show().delay(2000).fadeOut();
            },
            error: function(error) {
                console.error('Error updating sensor:', error);
                alert('Failed to update sensor.');
            }
        });
    });

    loadActions();
    help();

    // Handle add new action button click
    $('#add-new-action').click(function() {
        clearActionForm()
    });    

    // Add or Edit Action
    $('#save-action').click(function() {
        saveAction();
    });

    $('#test-action').click(function() {
        const actionId = $('#action-id').val();
        $('#test-result').html('');
        saveAction(function(actionId) {
            $('#updated-action').show().delay(2000).fadeOut();;
            // Then, execute the test action
            $.ajax({
                url: `/api/action/${actionId}/run/`,
                type: 'POST',
                headers: {'X-CSRFToken': Cookies.get('csrftoken')},
                success: function(response) {
                    const { response: resp, message: msg } = response;
                    let html = `<h3>${msg}</h3>`;
                    if(resp.expected_value === resp.actual_value || resp.actual_value == 'pass'){
                        html +='<p>&nbsp;</p><p><img src="/static/img/pass.png" width="90"></p>';
                        console.log("PASS",resp, resp.expected_value, resp.actual_value,"/static/img/pass.png");
                    }else{
                        '<p>&nbsp;</p><p><img src="/static/img/fail.png" width="90"></p>';
                        console.log("FAIL",resp, resp.expected_value, resp.actual_value,"/static/img/fail.png");
                    }
                    $('#test-result').html(html)
                    $('#test-result').append(`<br><br><pre>${JSON.stringify(resp, null, 2)}</pre>`);                    
                },
                error: function(xhr, status, error) {
                    $('#test-result').html(xhr.responseJSON.error)
                }
            });
        });
    });

    // Show or hide selenium field based on assertion type
    $('#assertion_type').change(function() {
        if ($(this).val() === 'selenium') {
            $('#selenium-section').show();
            $('#payload-section').hide();
            $('#payload-section').hide();
        } else {
            $('#selenium-section').hide();
            $('#payload-section').show();
        }
    });

    // Handle edit action button click
    $(document).on('click', '.edit-action', function() {
        $('#test-action').show();
        $('#addEditActionTitle').html(`Edit `);
        $('#test-result').html('');

        const actionId = $(this).data('id');
        $.ajax({
            url: `/api/action/${actionId}/`,
            method: 'GET',
            success: function(action) {
                $('#addEditActionTitle').html(`Edit "${action.action_name}"`);
                $('#action-id').val(action.id);
                $('#action_path').val(action.action_path);
                $('#action_name').val(action.action_name);
                $('#action_type').val(action.action_type);
                $('#assertion_type').val(action.assertion_type);
                if (action.assertion_type == "selenium") {
                    $('#selenium-section').show();
                    $('#payload-section').hide();
                    $('#selenium_script').val(action.selenium_script);
                    $('#expected_value').val('pass');
                    $('#payload').val('');
                } else {
                    $('#selenium-section').hide();
                    $('#payload-section').show();
                    $('#selenium_script').val('');
                    $('#payload').val(action.payload);
                    $('#expected_value').val(action.expected_value);
                }
                $('#action-form-title').text('Edit Action');
            },
            error: function(error) {
                console.error('Error fetching action details:', error);
            }
        });
    });

    // Handle delete action button click
    $(document).on('click', '.delete-action', function() {
        const actionId = $(this).data('id');
        if (confirm('Are you sure you want to delete this action?')) {
            $.ajax({
                url: `/api/action/${actionId}/`,
                method: 'DELETE',
                headers: {'X-CSRFToken': Cookies.get('csrftoken')},
                success: function() {
                    loadActions();
                },
                error: function(error) {
                    console.error('Error deleting action:', error);
                    alert('Failed to delete action.');
                }
            });
        }
    });

});
</script>
{% endblock %}